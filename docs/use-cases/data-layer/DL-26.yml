# DL-26: Manage Character Working State
# ======================================

id: "DL-26"
title: "Manage Character Working State"
category: "data-layer"
epic: 0
priority: "critical"
status: "todo"

summary: |
  Implement MongoDB collection for storing character working state during active
  gameplay. Pure data storage for base stats snapshot, current stats, resources,
  modifications, and temporary effects. Stat calculation and canonization logic
  live in the agents layer.

acceptance_criteria:
  - "mongodb_create_working_state creates working state document"
  - "mongodb_get_working_state returns state by entity_id and scene_id"
  - "mongodb_list_working_states returns states for scene"
  - "mongodb_update_working_state updates current_stats, resources"
  - "mongodb_delete_working_state removes state document"
  - "mongodb_add_modification appends to modifications array"
  - "mongodb_add_temp_effect appends to temporary_effects array"
  - "mongodb_update_temp_effect updates effect (duration, etc.)"
  - "mongodb_remove_temp_effect removes effect by ID"
  - "mongodb_add_inventory_change appends to inventory_changes"
  - "mongodb_mark_canonized sets canonized flag and timestamp"
  - "base_stats stores Neo4j snapshot (read-only reference)"
  - "modifications tracks all changes with source"
  - "Unit tests achieve >= 80% coverage"

depends_on:
  - "DL-2"   # Source of canonical entity stats
  - "DL-4"   # Working state scoped to scene

blocks:
  - "P-4"    # Player action modifies working state
  - "P-16"   # Combat uses working state

implementation:
  layer: 1

  files:
    create:
      - "packages/data-layer/src/monitor_data/schemas/working_state.py"
      - "packages/data-layer/tests/test_tools/test_working_state_tools.py"
    modify:
      - "packages/data-layer/src/monitor_data/tools/mongodb_tools.py"
      - "packages/data-layer/src/monitor_data/schemas/__init__.py"

  database_operations:
    mongodb:
      # Working state CRUD
      - name: "mongodb_create_working_state"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["entity_id", "scene_id", "story_id", "base_stats", "current_stats", "resources"]

      - name: "mongodb_get_working_state"
        authority: ["*"]
        params: ["entity_id", "scene_id"]

      - name: "mongodb_get_working_state_by_id"
        authority: ["*"]
        params: ["state_id"]

      - name: "mongodb_list_working_states"
        authority: ["*"]
        params: ["scene_id?", "story_id?", "canonized?", "limit?", "offset?"]

      - name: "mongodb_update_working_state"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["state_id", "current_stats?", "resources?"]

      - name: "mongodb_delete_working_state"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["state_id"]

      # Modifications tracking
      - name: "mongodb_add_modification"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["state_id", "stat_or_resource", "change", "source", "source_id"]

      # Temporary effects
      - name: "mongodb_add_temp_effect"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["state_id", "name", "source", "stat_modifiers", "duration_type", "duration_remaining"]

      - name: "mongodb_update_temp_effect"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["state_id", "effect_id", "duration_remaining?"]

      - name: "mongodb_remove_temp_effect"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["state_id", "effect_id"]

      # Inventory changes
      - name: "mongodb_add_inventory_change"
        authority: ["Orchestrator", "CanonKeeper"]
        params: ["state_id", "change_type", "item", "quantity"]

      # Canonization
      - name: "mongodb_mark_canonized"
        authority: ["CanonKeeper"]
        params: ["state_id"]

  patterns:
    - "character_working_state collection schema in DATA_LAYER_USE_CASES.md"
    - "base_stats: snapshot from Neo4j at init (reference only)"
    - "current_stats: base + accumulated modifications"
    - "resources structure: {hp: {current, max, temp}, mp: {current, max}, etc.}"
    - "modifications array: [{mod_id, stat_or_resource, change, source, source_id, timestamp}]"
    - "temporary_effects array: [{effect_id, name, source, stat_modifiers{}, duration_type, duration_remaining}]"
    - "Duration types enum: rounds, minutes, scene, concentration"
    - "inventory_changes: [{change_type, item, quantity}]"
    - "Change types enum: add, remove, use"

  notes: |
    - This is PURE DATA STORAGE - no calculation logic
    - Loading from Neo4j (init) lives in agents layer
    - Effective stat calculation lives in agents layer utilities
    - Duration ticking lives in agents layer
    - Canonization sync to Neo4j lives in agents layer
    - Multiple states can exist per entity (different scenes)

testing:
  unit_tests:
    - "test_create_state_success: state created"
    - "test_get_state_by_entity_scene: returns correct state"
    - "test_list_states_by_scene: scene filter works"
    - "test_list_states_canonized: canonized filter works"
    - "test_update_current_stats: stats updated"
    - "test_update_resources: resources updated"
    - "test_delete_state: state removed"
    - "test_add_modification: modification appended"
    - "test_add_temp_effect: effect appended"
    - "test_update_temp_effect: duration updated"
    - "test_remove_temp_effect: effect removed"
    - "test_add_inventory_change: change appended"
    - "test_mark_canonized: flag and timestamp set"

  integration_tests:
    - "test_state_with_modifications: full modification tracking"

  coverage_minimum: 80

github:
  labels:
    - "epic-0"
    - "data-layer"
    - "mongodb"
    - "priority-critical"

  milestone: "EPIC 0: Data Layer Access"

references:
  docs:
    - "docs/DATA_LAYER_USE_CASES.md#dl-26"

  code:
    - "packages/data-layer/src/monitor_data/db/mongodb.py"
