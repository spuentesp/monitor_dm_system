# DL-3: Manage Facts & Events
# ============================

id: "DL-3"
title: "Manage Facts & Events"
category: "data-layer"
epic: 0
priority: "high"
status: "todo"

summary: |
  Implement CRUD operations for Fact and Event nodes in Neo4j with full provenance
  tracking. Facts represent canonical truth about the world; Events are temporal
  facts with timestamps. Both support SUPPORTED_BY edges to Sources/Snippets/Scenes
  and INVOLVES/ABOUT edges to entities.

acceptance_criteria:
  - "neo4j_create_fact creates Fact node with required fields"
  - "neo4j_create_fact validates universe_id and entity references exist"
  - "neo4j_create_fact supports all fact_type values (state, relationship, attribute, event)"
  - "neo4j_create_fact creates SUPPORTED_BY edges to sources/snippets/scenes"
  - "neo4j_create_fact creates INVOLVES edges to referenced entities"
  - "neo4j_create_event creates Event node with temporal properties (start_time, end_time)"
  - "neo4j_create_event supports timeline ordering (NEXT, BEFORE, AFTER edges)"
  - "neo4j_get_fact returns fact with all relationships and provenance chain"
  - "neo4j_update_fact allows updating mutable fields and canon_level"
  - "neo4j_list_facts supports filtering by universe_id, entity_id, fact_type, canon_level"
  - "neo4j_delete_fact prevents deletion of confirmed facts unless force=true"
  - "All operations enforce CanonKeeper authority for writes"
  - "Unit tests achieve >= 80% coverage"

depends_on:
  - "DL-1"  # Facts belong to universes
  - "DL-2"  # Facts reference entities

blocks:
  - "DL-6"   # Plot threads reference facts
  - "DL-7"   # Memories may reference facts
  - "Q-1"    # Query facts
  - "Q-2"    # Query timeline

implementation:
  layer: 1

  files:
    create:
      - "packages/data-layer/src/monitor_data/schemas/facts.py"
      - "packages/data-layer/tests/test_tools/test_fact_tools.py"
    modify:
      - "packages/data-layer/src/monitor_data/tools/neo4j_tools.py"
      - "packages/data-layer/src/monitor_data/middleware/auth.py"

  database_operations:
    neo4j:
      - name: "neo4j_create_fact"
        authority: ["CanonKeeper"]
        params: ["universe_id", "statement", "fact_type", "entity_ids?", "source_ids?", "snippet_ids?", "scene_ids?", "canon_level?", "confidence?", "properties?"]

      - name: "neo4j_create_event"
        authority: ["CanonKeeper"]
        params: ["universe_id", "title", "description?", "start_time", "end_time?", "entity_ids?", "source_ids?", "timeline_after?", "timeline_before?"]

      - name: "neo4j_get_fact"
        authority: ["*"]
        params: ["fact_id"]

      - name: "neo4j_list_facts"
        authority: ["*"]
        params: ["universe_id?", "entity_id?", "fact_type?", "canon_level?", "limit", "offset"]

      - name: "neo4j_update_fact"
        authority: ["CanonKeeper"]
        params: ["fact_id", "statement?", "canon_level?", "confidence?", "properties?"]

      - name: "neo4j_delete_fact"
        authority: ["CanonKeeper"]
        params: ["fact_id", "force?"]

  patterns:
    - "Use SUPPORTED_BY edge for provenance (Fact)-[:SUPPORTED_BY]->(Source|Snippet|Scene)"
    - "Use INVOLVES edge for entity references (Fact)-[:INVOLVES]->(Entity)"
    - "Use canon_level enum: proposed, confirmed, retconned"
    - "Events have temporal properties and timeline edges"

  notes: |
    - Fact vs Event: Events have explicit timestamps, Facts are timeless assertions
    - SUPPORTED_BY creates provenance chain for canonization verification
    - confidence is 0.0-1.0, canon_level is the authoritative status
    - Timeline edges (NEXT, BEFORE, AFTER) only apply to Events

testing:
  unit_tests:
    - "test_create_fact_success: valid params → Fact node created"
    - "test_create_fact_with_provenance: source_ids → SUPPORTED_BY edges"
    - "test_create_fact_with_entities: entity_ids → INVOLVES edges"
    - "test_create_event_with_timeline: timeline params → ordering edges"
    - "test_get_fact_with_relationships: returns full provenance chain"
    - "test_list_facts_by_entity: entity filter works"
    - "test_list_facts_by_canon_level: canon_level filter works"
    - "test_update_fact_canon_level: proposed → confirmed transition"
    - "test_delete_confirmed_fact: without force → error"

  integration_tests:
    - "test_fact_lifecycle: create with provenance → update → delete"
    - "test_event_timeline: create events → establish ordering → query timeline"

  coverage_minimum: 80

github:
  labels:
    - "epic-0"
    - "data-layer"
    - "neo4j"
    - "priority-high"

  milestone: "EPIC 0: Data Layer Access"

references:
  docs:
    - "docs/ontology/ONTOLOGY.md#25-facts-events"
    - "docs/architecture/DATABASE_INTEGRATION.md"

  code:
    - "packages/data-layer/src/monitor_data/schemas/base.py"
