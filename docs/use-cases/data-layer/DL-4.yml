# DL-4: Manage Stories, Scenes, Turns
# ====================================

id: "DL-4"
title: "Manage Stories, Scenes, Turns"
category: "data-layer"
epic: 0
priority: "high"
status: "done"

summary: |
  Implement CRUD operations for Stories (Neo4j), Scenes (MongoDB), and Turns (MongoDB).
  Stories are canonical containers linking to universes. Scenes are narrative episodes
  stored in MongoDB for flexibility. Turns are individual exchanges within scenes.
  Supports status transitions and participant tracking.

acceptance_criteria:
  - "neo4j_create_story creates Story node linked to universe"
  - "neo4j_create_story validates universe_id exists"
  - "neo4j_get_story returns story with metadata and scene count"
  - "neo4j_update_story allows updating title, status, and metadata"
  - "mongodb_create_scene creates Scene document with story reference"
  - "mongodb_create_scene validates story_id exists in Neo4j"
  - "mongodb_get_scene returns scene with all turns"
  - "mongodb_update_scene enforces valid status transitions"
  - "mongodb_append_turn adds turn to scene with proper ordering"
  - "mongodb_list_scenes supports filtering by story_id, status"
  - "All operations track created_at and updated_at timestamps"
  - "Status transitions follow: planned → active → completed → archived"
  - "Unit tests achieve >= 80% coverage"

depends_on:
  - "DL-1"  # Stories belong to universes
  - "DL-2"  # Scenes reference entity participants

blocks:
  - "DL-5"   # Proposed changes reference scenes
  - "DL-6"   # Plot threads link to scenes
  - "DL-7"   # Memories reference scenes
  - "P-1"    # Start new story
  - "P-2"    # Begin scene

implementation:
  layer: 1

  files:
    create:
      - "packages/data-layer/src/monitor_data/schemas/stories.py"
      - "packages/data-layer/src/monitor_data/schemas/scenes.py"
      - "packages/data-layer/tests/test_tools/test_story_tools.py"
      - "packages/data-layer/tests/test_tools/test_scene_tools.py"
    modify:
      - "packages/data-layer/src/monitor_data/tools/neo4j_tools.py"
      - "packages/data-layer/src/monitor_data/tools/mongodb_tools.py"
      - "packages/data-layer/src/monitor_data/middleware/auth.py"

  database_operations:
    neo4j:
      - name: "neo4j_create_story"
        authority: ["CanonKeeper"]
        params: ["universe_id", "title", "story_type", "theme?", "premise?", "pc_ids?"]

      - name: "neo4j_get_story"
        authority: ["*"]
        params: ["story_id"]

      - name: "neo4j_update_story"
        authority: ["CanonKeeper"]
        params: ["story_id", "title?", "status?", "metadata?"]

      - name: "neo4j_list_stories"
        authority: ["*"]
        params: ["universe_id?", "status?", "limit", "offset"]

    mongodb:
      - name: "mongodb_create_scene"
        authority: ["CanonKeeper", "Narrator"]
        params: ["story_id", "title", "location_id?", "participant_ids?", "setup?"]

      - name: "mongodb_get_scene"
        authority: ["*"]
        params: ["scene_id"]

      - name: "mongodb_update_scene"
        authority: ["CanonKeeper", "Narrator"]
        params: ["scene_id", "status?", "summary?", "metadata?"]

      - name: "mongodb_list_scenes"
        authority: ["*"]
        params: ["story_id?", "status?", "limit", "offset"]

      - name: "mongodb_append_turn"
        authority: ["*"]
        params: ["scene_id", "actor", "content", "turn_type", "metadata?"]

  patterns:
    - "Story nodes in Neo4j for canonical container"
    - "Scene documents in MongoDB for narrative flexibility"
    - "Turns are embedded array in Scene document"
    - "Use story_type enum: campaign, arc, episode, one_shot"
    - "Use status enum: planned, active, completed, archived"

  notes: |
    - Neo4j stores Story for graph queries and canonization
    - MongoDB stores Scenes/Turns for flexible narrative data
    - Consider optional Scene node in Neo4j for complex queries
    - Turns include: narrator, player, system, ooc types

testing:
  unit_tests:
    - "test_create_story_success: valid params → Story node"
    - "test_create_story_with_pcs: pc_ids → PARTICIPATES edges"
    - "test_create_scene_success: valid params → Scene doc"
    - "test_append_turn: adds turn with correct order"
    - "test_scene_status_transition: valid transitions work"
    - "test_scene_status_invalid: invalid transition → error"
    - "test_list_scenes_by_story: story filter works"
    - "test_list_scenes_by_status: status filter works"

  integration_tests:
    - "test_story_lifecycle: create story → add scenes → add turns → complete"
    - "test_story_with_participants: story with PCs → scene with participants"

  coverage_minimum: 80

github:
  labels:
    - "epic-0"
    - "data-layer"
    - "neo4j"
    - "mongodb"
    - "priority-high"

  milestone: "EPIC 0: Data Layer Access"

references:
  docs:
    - "docs/ontology/ONTOLOGY.md#26-narrative-structures"
    - "docs/architecture/DATABASE_INTEGRATION.md"

  code:
    - "packages/data-layer/src/monitor_data/db/neo4j.py"
    - "packages/data-layer/src/monitor_data/db/mongodb.py"
